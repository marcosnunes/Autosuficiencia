<!DOCTYPE html>
<html>
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css">
  <title>Janeiro</title>

 <style>
     
    .iframe-container {
      position: relative;
      overflow: hidden;
      width: 100%;
      padding-top: 56.25%; /* Proporção de aspecto para manter a proporção do gráfico (por exemplo, 16:9 seria 56.25%) */
    }
    .iframe-container iframe {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
    }
 
 .nav-wrapper {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 10px;
}

.brand-logo {
  flex: 1;
  text-align: center;
}

.nav-btn-left,
.nav-btn-right {
  padding: 5px 10px;
  background-color: #ccc;
  border: none;
  font-size: 16px;
  cursor: pointer;
}

 </style>  

</head>
<body>

<nav>
  <div class="nav-wrapper">
    <button onclick="window.location.href='index.html'" class="btn btn-default">&lt;</button>
    <span class="brand-logo center">Janeiro</span>
    <button onclick="window.location.href='2Fev.html'" class="btn btn-default">&gt;</button>
  </div>
</nav>

<div class="container">


<div class="iframe-container">
  <iframe src="chart.html" frameborder="0"></iframe>
</div>

<script>
  function resizeIframe() {
    var iframe = document.querySelector('.iframe-container iframe');
    var container = document.querySelector('.iframe-container');
    var containerWidth = container.offsetWidth;
    var aspectRatio = 9 / 16;

    var newHeight = containerWidth * aspectRatio;
    iframe.style.height = newHeight + 'px';
  }

  window.addEventListener('load', resizeIframe);
  window.addEventListener('resize', resizeIframe);
</script>



  <div class="input-field">
    <input type="number" class="form-control" id="initialBalance" oninput="calculateTotal()" placeholder="Saldo Inicial">
    <label for="initialBalance">Saldo Inicial</label>
  </div>
  
  <div class="row">
    <div class="col s12">
      <button onclick="clearRow(this)" class="btn btn-default">Inserir Linha</button>
    </div>
  </div>

  <table id="myTable">
    <thead>
      <tr>
        <th>Descrição</th>
        <th>Débito</th> 
        <th>Crédito</th>
        <th>Feito</th>
        <th></th>
      </tr>
    </thead>
    <tbody>
      <tr class="auto-insert-row">
        <td><input type="text" class="description form-control"></td>
        <td><input type="number" class="debit form-control" oninput="calculateTotal()"></td> 
        <td><input type="number" class="credit form-control" oninput="calculateTotal()"></td>
        <td>
          <label>
            <input type="checkbox" class="filled-in" id="checkbox-0" onchange="updateCurrentBalance(this)">
            <span></span>
          </label>
        </td>
        <td><button onclick="deleteRow(this)" class="btn btn-default">-</button></td>
      </tr>
    </tbody>
  </table>

  <p>Saldo Atual: <span id="currentBalance"></span></p>
  <p>Fechamento do mês: <span id="total"></span></p>
  <p>Total Crédito: <span id="totalCredit"></span></p>
  <p>Total Débito: <span id="totalDebit"></span></p>
  <p>Débito ÷ Crédito: <span id="totalPorcentagem"></span></p>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
<script>

document.addEventListener('DOMContentLoaded', function() {
  M.AutoInit();
  loaddata();
  removeAutoInsertRow();
  
  // Carregar o saldo atual salvo em localStorage e atualizar a página com o valor salvo
  var savedCurrentBalance = localStorage.getItem('currentBalance');
  if (savedCurrentBalance) {
    document.getElementById('currentBalance').textContent = savedCurrentBalance;
  }
});

function updateCurrentBalance(checkbox) {
  var initialBalance = Number(document.getElementById("initialBalance").value);
  var debitInputs = document.querySelectorAll(".debit");
  var creditInputs = document.querySelectorAll(".credit");
  var checkboxInputs = document.querySelectorAll(".filled-in");
  var selectedCreditTotal = 0;
  var selectedDebitTotal = 0;

  for (var i = 0; i < checkboxInputs.length; i++) {
    if (checkboxInputs[i].checked) {
      selectedCreditTotal += Number(creditInputs[i].value);
      selectedDebitTotal += Number(debitInputs[i].value);
    }
  }

  var currentBalance = initialBalance + selectedCreditTotal - selectedDebitTotal;

  var formattedCurrentBalance = currentBalance.toFixed(2);

  document.getElementById("currentBalance").textContent = formattedCurrentBalance;

  // Salvar o saldo atual em localStorage
  localStorage.setItem('currentBalance', formattedCurrentBalance);
}

function removeAutoInsertRow() {
  var autoInsertRows = document.querySelectorAll('.auto-insert-row');
  for (var i = 0; i < autoInsertRows.length; i++) {
    autoInsertRows[i].remove();
  }
}

function calculateTotal() {
  var initialBalance = Number(document.getElementById("initialBalance").value);
  var debitTotal = 0;
  var creditTotal = 0;
  var debitInputs = document.querySelectorAll(".debit");
  var creditInputs = document.querySelectorAll(".credit");
  var totalPorcentagem = 0;
  
  for (var i = 0; i < debitInputs.length; i++) {
    debitTotal += Number(debitInputs[i].value);
  }
  
  for (var i = 0; i < creditInputs.length; i++) {
    creditTotal += Number(creditInputs[i].value);
  }
  
  var total = initialBalance + creditTotal - debitTotal;
  // Usando toFixed(2) para mostrar apenas 2 casas decimais após a vírgula
  var formattedTotal = total.toFixed(2);
  
  document.getElementById("total").textContent = formattedTotal;
  document.getElementById("totalCredit").textContent = creditTotal.toFixed(2);
  document.getElementById("totalDebit").textContent = debitTotal.toFixed(2);

  var percentage = 0;
  if (creditTotal !== 0) {
    percentage = (debitTotal / creditTotal) * 100;
  }
  var formattedPercentage = percentage.toFixed(2);
  
  document.getElementById("totalPorcentagem").textContent = formattedPercentage + "%";
  
  savedata();
}


function savedata() {
  var totalJaneiro = {};
  totalJaneiro.initialBalance = document.getElementById("initialBalance").value;
  totalJaneiro.total = document.getElementById("total").textContent;
  totalJaneiro.rows = [];
  var tableRows = document.querySelectorAll("#myTable tbody tr:not(.auto-insert-row)");
  for (var i = 0; i < tableRows.length; i++) {
    var row = {};
    row.description = tableRows[i].querySelector(".description").value;
    row.debit = tableRows[i].querySelector(".debit").value;
    row.credit = tableRows[i].querySelector(".credit").value;
    row.checked = tableRows[i].querySelector(".filled-in").checked; // Obtém o estado da checkbox
    totalJaneiro.rows.push(row);
  }
  localStorage.setItem("totalJaneiro", JSON.stringify(totalJaneiro));
}

function loaddata() {
  var totalJaneiro = JSON.parse(localStorage.getItem("totalJaneiro"));
  if (totalJaneiro) {
    document.getElementById("initialBalance").value = totalJaneiro.initialBalance;
    var table = document.getElementById("myTable");
    var tbody = table.querySelector("tbody");
    if (!tbody) {
      tbody = document.createElement("tbody");
      table.appendChild(tbody);
    } else {
      // Limpar as linhas existentes para recarregar os dados atualizados
      tbody.innerHTML = "";
    }

    for (var i = 0; i < totalJaneiro.rows.length; i++) {
      var row = document.createElement("tr");
      row.innerHTML = `
        <td><input type="text" class="description form-control" value="${totalJaneiro.rows[i].description}"></td>
        <td><input type="number" class="debit form-control" oninput="calculateTotal()" value="${totalJaneiro.rows[i].debit}"></td>
        <td><input type="number" class="credit form-control" oninput="calculateTotal()" value="${totalJaneiro.rows[i].credit}"></td>
        <td>
          <label>
            <input type="checkbox" class="filled-in" id="checkbox-${i}" onchange="updateCurrentBalance(this)" ${totalJaneiro.rows[i].checked ? "checked" : ""}>
            <span></span>
          </label>
        </td>
        <td><button onclick="deleteRow(this)" class="btn btn-default">-</button></td>
      `;
      tbody.appendChild(row);
    }

    calculateTotal(); // Chama calculateTotal() após carregar os dados para calcular o saldo total corretamente.
  }
}


window.addEventListener("beforeunload", function() {
  savedata();
});

function clearRow(button) {
  var table = document.getElementById("myTable");
  var row = document.createElement("tr");
  row.innerHTML = `
    <td><input type="text" class="description form-control"></td>
    <td><input type="number" class="debit form-control" oninput="calculateTotal()"></td>
    <td><input type="number" class="credit form-control" oninput="calculateTotal()"></td>
    <td>
      <label>
        <input type="checkbox" class="filled-in" onchange="updateCurrentBalance(this)">
        <span></span>
      </label>
    </td>
    <td><button onclick="deleteRow(this)" class="btn btn-default">-</button></td>
  `;
  table.querySelector("tbody").appendChild(row);
  calculateTotal();
}

function deleteRow(button) {
  var table = document.getElementById("myTable");
  button.closest("tr").remove();
  calculateTotal();
  updateCurrentBalance();
}

</script>

</body>
</html>
